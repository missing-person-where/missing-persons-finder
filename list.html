<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寻人列表 - Missing Persons Platform</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>寻人启示平台</h1>
                <p>让爱回家 - Helping families reunite</p>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">首页</a></li>
                    <li><a href="list.html" class="active">寻人列表</a></li>
                    <li><a href="submit.html">发布寻人</a></li>
                    <li><a href="about.html">关于我们</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="filters">
                <div class="search-bar">
                    <input type="text" id="searchInput" class="form-control" placeholder="输入姓名或关键词搜索...">
                    <select id="locationInput" class="form-control" style="max-width: 200px;">
                        <option value="">所有地区 / All Locations</option>
                        <option value="北京">北京 / Beijing</option>
                        <option value="上海">上海 / Shanghai</option>
                        <option value="广州">广州 / Guangzhou</option>
                        <option value="深圳">深圳 / Shenzhen</option>
                        <option value="其他">其他 / Other</option>
                    </select>
                    <button id="searchBtn" class="btn btn-primary">搜索 / Search</button>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                    <!-- Simple filters for now -->
                    <!-- <label><input type="checkbox"> 只看未成年</label> -->
                </div>
            </div>

            <div class="grid" id="list-grid">
                <div style="text-align: center; width: 100%; grid-column: 1 / -1;">
                    <p>加载中... / Loading...</p>
                </div>
            </div>
            
            <!-- Pagination could be added here -->
        </div>
    </main>

    <script type="module">
        import { supabase } from './js/supabase-client.js';

        async function loadCases() {
            const container = document.getElementById('list-grid');
            const searchInput = document.getElementById('searchInput').value;
            const locationInput = document.getElementById('locationInput').value;

            container.innerHTML = '<div style="text-align: center; width: 100%; grid-column: 1 / -1;"><p>加载中... / Loading...</p></div>';

            try {
                let query = supabase
                    .from('missing_persons')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (searchInput) {
                    query = query.ilike('name', `%${searchInput}%`);
                }

                if (locationInput) {
                    query = query.ilike('missing_location', `%${locationInput}%`);
                }

                const { data: cases, error } = await query;

                if (error) throw error;

                if (!cases || cases.length === 0) {
                    container.innerHTML = '<div style="text-align: center; width: 100%; grid-column: 1 / -1;"><p>暂无匹配信息 / No cases found.</p></div>';
                    return;
                }

                container.innerHTML = cases.map(person => `
                    <div class="card">
                        <img src="${person.photo_url || 'https://placehold.co/400x300?text=No+Image'}" alt="${person.name}" class="card-img">
                        <div class="card-body">
                            <h4 class="card-title">${person.name}</h4>
                            <p class="card-text"><strong>年龄 / Age:</strong> ${person.dob ? (new Date().getFullYear() - new Date(person.dob).getFullYear()) + '岁' : '未知'}</p>
                            <p class="card-text"><strong>地点 / Location:</strong> ${person.missing_location}</p>
                            <p class="card-text"><strong>时间 / Date:</strong> ${new Date(person.missing_date).toLocaleDateString()}</p>
                            <a href="detail.html?id=${person.id}" class="btn btn-outline" style="display: block; text-align: center; margin-top: 1rem;">查看详情</a>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Error loading cases:', err);
                container.innerHTML = '<div style="text-align: center; width: 100%; grid-column: 1 / -1; color: red;"><p>加载失败，请刷新重试。</p></div>';
            }
        }

        document.getElementById('searchBtn').addEventListener('click', loadCases);
        
        // Load on start
        loadCases();
    </script>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 寻人启示公益平台 Missing Persons Finder</p>
            <p>联系我们: contact@missingpersons.org | 电话: 400-123-4567</p>
        </div>
    </footer>
</body>
</html>